Here is a SQL Table with a common expression:
Finding out the top 5 customer base within each country


WITH TopCities AS (
    -- Subquery to find the top 10 cities by customer count
    SELECT 
        city.city_id
    FROM 
        customer
    JOIN 
        address ON customer.address_id = address.address_id
    JOIN 
        city ON address.city_id = city.city_id
    JOIN 
        country ON city.country_id = country.country_id
    GROUP BY 
        city.city_id
    ORDER BY 
        COUNT(customer.customer_id) DESC
    LIMIT 10
),
TopCustomers AS (
    -- Subquery to find the top 5 customers by total amount paid
    SELECT 
        customer.customer_id, 
        country.country
    FROM 
        customer
    JOIN 
        address ON customer.address_id = address.address_id
    JOIN 
        city ON address.city_id = city.city_id
    JOIN 
        country ON city.country_id = country.country_id
    JOIN 
        rental ON customer.customer_id = rental.customer_id
    JOIN 
        payment ON rental.rental_id = payment.rental_id
    WHERE 
        city.city_id IN (SELECT city_id FROM TopCities)
    GROUP BY 
        customer.customer_id, country.country
    ORDER BY 
        SUM(payment.amount) DESC
    LIMIT 5
)
-- Final query to count all customers and top customers by country
SELECT 
    country.country, 
    COUNT(customer.customer_id) AS all_customer_count,
    COUNT(top_customers.customer_id) AS top_customer_count
FROM 
    customer
JOIN 
    address ON customer.address_id = address.address_id
JOIN 
    city ON address.city_id = city.city_id
JOIN 
    country ON city.country_id = country.country_id
LEFT JOIN 
    TopCustomers AS top_customers ON customer.customer_id = top_customers.customer_id
GROUP BY 
    country.country
ORDER BY 
    all_customer_count DESC;
